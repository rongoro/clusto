<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Services &mdash; clusto v0.5.25 documentation</title>
    <link rel="stylesheet" href="static/default.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.5.25',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <link rel="top" title="clusto v0.5.25 documentation" href="index.html" />
    <link rel="next" title="Command line usage" href="cmdline.html" />
    <link rel="prev" title="Using clusto" href="using.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="cmdline.html" title="Command line usage"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="using.html" title="Using clusto"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">clusto v0.5.25 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="services">
<h1>Services<a class="headerlink" href="#services" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Release:</th><td class="field-body">0.5</td>
</tr>
<tr class="field"><th class="field-name">Date:</th><td class="field-body">April 27, 2010</td>
</tr>
</tbody>
</table>
<div class="section" id="dhcp-server">
<h2>DHCP server<a class="headerlink" href="#dhcp-server" title="Permalink to this headline">¶</a></h2>
<p>As clusto acts as a single source of truth about your network, it only makes sense that you would use it for assigning network configuration to servers. Clusto&#8217;s DHCP server isn&#8217;t really dynamic though, it only hands out IPs that are already bound to server objects in the database and ignores DHCP requests from hosts that don&#8217;t exist in the database or don&#8217;t have IPs bound, though in both cases it will log a warning with details.</p>
<p>The design of clusto-dhcpd is a bit different from the other daemons in that it communicates with the clusto database entirely over HTTP via the clusto-httpd daemon. This method was used to avoid the transfer of large result sets from the database to the DHCP server when certain queries took place (eg. IPManager.get_ip_manager), only to have the results filtered later on. Admittedly, this is due to inefficient querying by the clusto library and will probably be fixed in a later release.</p>
<div class="section" id="configuration-options">
<h3>Configuration options<a class="headerlink" href="#configuration-options" title="Permalink to this headline">¶</a></h3>
<p><em>api_url</em>
The base URL of the clusto-httpd server. Must NOT include a trailing slash</p>
<p><em>update_ipmi</em>
Boolean that sets whether or not requests will be checked for a client_id that resembles an IPMI card and distinguish it from a normal server MAC. If you don&#8217;t have IPMI cards that use the same physical interfaces as your eth0, you probably don&#8217;t need this.</p>
<p><em>extra_options</em>
Specify custom options that can be set via clusto attributes, in addition to those already supported by scapy. This is a dict where the key is an integer option ID and the value is a name to map to that option, to be used later as a subkey.</p>
</div>
<div class="section" id="usage">
<h3>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h3>
<p>Upon receiving a DHCP request packet, clusto-dhcpd will look for any server object in the database with a Attribute(key=&#8217;port-nic-eth&#8217;, subkey=&#8217;mac&#8217;, value=&#8216;00:11:22:33:44:55&#8217;, number=1). If no object is found, the request is ignored. Otherwise, the daemon queries Attribute(key=&#8217;dhcp&#8217;, subkey=&#8217;enabled&#8217;, value=1, merge_container_attrs=True). This attribute is merged so that you can enable DHCP at a pool or datacenter level, depending on your needs. If the enabled attribute is found, the daemon builds a response based upon any remaining key=&#8217;dhcp&#8217; attributes, including those merged from the parents. More specific attributes take precedence.</p>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="s">&#39;pxeboot-servers&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">set_attr</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s">&#39;dhcp&#39;</span><span class="p">,</span> <span class="n">subkey</span><span class="o">=</span><span class="s">&#39;enabled&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">set_attr</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s">&#39;dhcp&#39;</span><span class="p">,</span> <span class="n">subkey</span><span class="o">=</span><span class="s">&#39;tftp_server&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s">&#39;192.168.1.1&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">set_attr</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s">&#39;dhcp&#39;</span><span class="p">,</span> <span class="n">subkey</span><span class="o">=</span><span class="s">&#39;tftp_filename&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s">&#39;/pxelinux.0&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">set_attr</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s">&#39;dhcp&#39;</span><span class="p">,</span> <span class="n">subkey</span><span class="o">=</span><span class="s">&#39;domain&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s">&#39;example.org&#39;</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">BasicServer</span><span class="p">(</span><span class="s">&#39;ex0000&#39;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">set_port_attr</span><span class="p">(</span><span class="s">&#39;nic-eth&#39;</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="s">&#39;mac&#39;</span><span class="p">,</span> <span class="s">&#39;00:11:22:33:44:55&#39;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">bind_ip_to_osport</span><span class="p">(</span><span class="s">&#39;192.168.1.50&#39;</span><span class="p">,</span> <span class="s">&#39;eth0&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="snmp-trap-listener">
<h2>SNMP trap listener<a class="headerlink" href="#snmp-trap-listener" title="Permalink to this headline">¶</a></h2>
<p>One of the services that ships with clusto called clusto-snmptrapd, will listen for SNMP traps from Cisco switches implementing the CISCO-MAC-NOTIFICATION-MIB which can be enabled with the following configuration on supported IOS releases:</p>
<div class="highlight-python"><pre>snmp-server enable traps mac-notification change
snmp-server host &lt;ip&gt; version 2c &lt;community&gt;  mac-notification
mac address-table notification change
!
interface &lt;int&gt;
  snmp trap mac-notification change added</pre>
</div>
<p>When clusto-snmptrapd receives one of these traps, it gathers the IP of the switch, the port number, the VLAN that learned the MAC, and the MAC itself. It then queries the clusto database for the switch IP and checks for an attribute of key=&#8217;snmp&#8217;, subkey=&#8217;discovery&#8217;, value=1... If this attribute is set on the switch or any of it&#8217;s parents, the daemon checks to see if there&#8217;s an object connected to the switch port in clusto. If not, then we assume this is a new server and create a new PenguinServer object with a name generated from a SimpleEntityNameManager called &#8216;servernames&#8217;. The daemon then gets the switch&#8217;s parent rack, gets the rack factory for that rack, then calls add_server(server, switchport) on the rack factory instance.</p>
<p>It&#8217;s a bit of a complicated process, but the end result is that new servers get added to clusto automatically as soon as they appear on the network without any human intervention aside from creating the rack instance.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="">Services</a><ul>
<li><a class="reference external" href="#dhcp-server">DHCP server</a><ul>
<li><a class="reference external" href="#configuration-options">Configuration options</a></li>
<li><a class="reference external" href="#usage">Usage</a></li>
<li><a class="reference external" href="#example">Example</a></li>
</ul>
</li>
<li><a class="reference external" href="#snmp-trap-listener">SNMP trap listener</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="using.html"
                                  title="previous chapter">Using clusto</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="cmdline.html"
                                  title="next chapter">Command line usage</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="sources/services.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="cmdline.html" title="Command line usage"
             >next</a> |</li>
        <li class="right" >
          <a href="using.html" title="Using clusto"
             >previous</a> |</li>
        <li><a href="index.html">clusto v0.5.25 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2010, Digg, Inc..
      Last updated on Apr 27, 2010.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.3.
    </div>
  </body>
</html>